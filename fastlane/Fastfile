default_platform(:android)

platform :android do

  desc "Analiza el c칩digo con SonarQube y reporta cobertura"

    lane :scan_code do |options|

      target_module = options[:module]

      sonar_module_name = target_module.delete_prefix(":")

      UI.message("游꿢 Enfocando an치lisis en: #{target_module}")

      gradle(task: "clean #{target_module}:testDebugUnitTest #{target_module}:koverXmlReport")

      project_root = File.expand_path("..", Dir.pwd)
      report_path = "#{project_root}/#{sonar_module_name}/build/reports/kover/report.xml"
      
      UI.message("游늭 Ruta configurada para reporte de cobertura: #{report_path}")

      if ENV['SONAR_TOKEN']
        gradle(
          task: "sonar",
          flags: "--info " +
                 "--init-script /workspace/sonar-injection.gradle.kts " +
                 "-Dsonar.host.url=#{ENV['SONAR_HOST_URL']} " +
                 "-Dsonar.token=#{ENV['SONAR_TOKEN']} " +
                 "-Dsonar.projectKey=#{ENV['SONAR_PROJECT_KEY']}:#{sonar_module_name} " +
                 "-Dsonar.projectName='#{sonar_module_name}' " +
                 "-Dsonar.includedModules=#{sonar_module_name} " +
                 "-Dsonar.coverage.jacoco.xmlReportPaths=#{report_path}"
        )
      end
    end

  desc "Publica el artefacto en Nexus"
    lane :publish_nexus do |options|

        target_module = options[:module]
        version_name = options[:version]

        UI.message("游 Publicando SOLO el m칩dulo: #{target_module} con versi칩n: #{version_name}")

        gradle(
            task: "#{target_module}:publishReleasePublicationToNexusOnPremiseRepository",
            properties: {
                "libraryVersion" => version_name
            }
        )
    end
end
